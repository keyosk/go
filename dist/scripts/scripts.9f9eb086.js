"use strict";angular.module("gonubApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/game/:lobbyName/:boardSize",{templateUrl:"views/game.html",controller:"GameCtrl"}).when("/game/:lobbyName",{templateUrl:"views/game.html",controller:"GameCtrl"}).when("/game",{templateUrl:"views/game.html",controller:"GameCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("gonubApp").controller("MainCtrl",["$scope",function(){}]),angular.module("gonubApp").controller("GameCtrl",["$scope","$log","$routeParams","$location",function(a,b,c,d){var e=function(a){for(var b="",c="abcdefghijklmnopqrstuvwxyz0123456789",d=0;a>d;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b},f=e(5),g=9,h="historyPlayBackSpeed"in c?c.historyPlayBackSpeed:0,i=!1;"lobbyName"in c&&c.lobbyName.trim().length>0?f=c.lobbyName:i=!0,"boardSize"in c&&c.boardSize>=3&&c.boardSize<=19?g=c.boardSize:i=!0,i&&d.path("/game/"+f+"/"+g);var j="0.0.2",k=PUBNUB.init({subscribe_key:"sub-c-cbcff300-bb84-11e3-b6e0-02ee2ddab7fe",publish_key:"pub-c-01bb4e6e-4ad8-4c62-9b72-5278a11cf9e5"}),l=PUBNUB.get_uuid(),m="go-game-"+j+"-"+f+"-"+g,n=CREATE_GO({containerEle:document.getElementById("game"),lobbyName:f,boardSize:g,pubnubUUID:l,dataChangedCallback:function(){a.boardStruct=n.boardStruct,a.playedPositions=n.playedPositions,a.currentPlayer=n.currentPlayer,a.currentPlayerColor=n.getColorClass(n.currentPlayer),a.lastPosition=n.lastPosition,a.whiteTurf=n.whiteTurf,a.blackTurf=n.blackTurf,a.whiteTurfCount=Object.keys(n.whiteTurf).length,a.blackTurfCount=Object.keys(n.blackTurf).length,a.whitePrisoners=n.whitePrisoners,a.blackPrisoners=n.blackPrisoners,a.turfIsVisible=n.turfIsVisible},clickCallback:function(a,b,c){k.publish({channel:m,message:{type:"move",forPlayer:c,x:a,y:b,pubnubUUID:l,time:(new Date).getTime()}})},passCallback:function(){return n.movers[n.currentPlayer]&&n.movers[n.currentPlayer]!==l?void alert("You are not allowed to pass for another player."):void(confirm("Are you sure you want to Pass?")&&k.publish({channel:m,message:{type:"pass",forPlayer:n.currentPlayer,pubnubUUID:l,time:(new Date).getTime()}}))},undoCallback:function(){var a=n.movers[n.currentPlayer]&&n.movers[n.currentPlayer]===l,b=n.movers[n.getOppositePlayer(n.currentPlayer)]&&n.movers[n.getOppositePlayer(n.currentPlayer)]===l;return a===!0&&b===!1?void alert("You are only allowed to undo your own move."):void(confirm("Are you sure you want to Undo?")&&k.publish({channel:m,message:{type:"undo",forPlayer:n.getOppositePlayer(n.currentPlayer),pubnubUUID:l,time:(new Date).getTime()}}))}});window.GO=n;var o=function(a){function b(){k.history(h)}var c=a.channel,d=a.callback,e=0,f=100,g=[],h={channel:c,count:f,reverse:!1,callback:function(a){var c=a[0];return e=a[1],h.start=e,PUBNUB.each(c.reverse(),function(a){g.push(a)}),c.length<f?d(g.reverse()):(f=100,void b())}};b()};a.moveTo=function(a,b){var c=n.currentPlayer;if(n.movers[c]&&n.movers[c]!==n.pubnubUUID)return void alert("That piece belongs to someone else.");var d=n.moveStoneToXY(n.currentPlayer,a,b);d&&(n.cachePlayedPosition({type:"move",forPlayer:c,x:a,y:b}),"function"==typeof n.clickCallback&&n.clickCallback(a,b,n.getOppositePlayer(n.currentPlayer)))},a.boardStruct=n.boardStruct,o({channel:m,callback:function(b){if(b.length)if(b=n.rollBackHistoryUsingUndo(b),0===h){for(var c in b)n.processPubNubPayload(b[c],!0);a.$apply(function(){n.dataChangedCallback()})}else{var d=function(){if(0!==b.length){var c=b.shift();n.processPubNubPayload(c,!0),a.$apply(function(){n.dataChangedCallback()}),setTimeout(d,h)}};d()}},error:function(){}}),k.subscribe({channel:m,callback:function(b){n.processPubNubPayload(b,!1),a.$apply(function(){n.dataChangedCallback()})}}),a.$on("$destroy",function(){k.unsubscribe({channel:m})}),a.toggleTurfCount=function(){n.toggleTurfCount()}}]),angular.module("gonubApp").controller("NavigationCtrl",["$scope","$location",function(a,b){a.isCurrentPath=function(a){return"/"===a?b.path()===a:0===b.path().indexOf(a)}}]);var sounds=function(){function a(a){a&&(a.pause(),b(a))}function b(a){try{a.currentTime=0}catch(b){}}var c={},d=PUBNUB;return{play:function(b,e){var f=c[b]||function(){var a=c[b]=d.create("audio");return d.css(a,{display:"none"}),d.attr(a,"prelaod","auto"),d.attr(a,"autoplay","true"),a.innerHTML=d.supplant('<source src="/sounds/{file}.wav"><source src="/sounds/{file}.ogg"><source src="/sounds/{file}.mp3">"',{file:b}),d.search("body")[0].appendChild(a),a}();a(f),f.load(),f.play(),clearTimeout(f.timer),e&&(f.timer=setTimeout(function(){a(f)},e))},stop:function(b){a(c[b])},stopAll:function(){d.each(c,function(b,c){a(c)})}}}();!function(){var a=function(b){var c=function(b){return a(b)},d=0;return c.initted=!1,c.turfIsVisible=!1,c.movers={},c.focused=!0,c.lobbyName=b.lobbyName,c.boardSize=b.boardSize,c.pubnubUUID=b.pubnubUUID,c.clickCallback=b.clickCallback,c.passCallback=b.passCallback,c.undoCallback=b.undoCallback,c.dataChangedCallback=b.dataChangedCallback,c.playedPositions=[],c.lastPrisonersTaken=[],c.getOppositePlayer=function(a){return 0===a?1:0},c.handleOnBlur=function(){c.focused=!1},c.handleOnFocus=function(){c.focused=!0},c.createEmptyBoardStruct=function(){for(var a=[],b=0;b<c.boardSize;b++){a.push([]);for(var d=0;d<c.boardSize;d++)a[b].push(-1)}return a},c.getPositionValid=function(a,b,e){if(-1!==c.boardStruct[b][e])return!1;var f=c.adjacentPositionFinder(b,e);d=0;var g=c.findDataForAdjacentPositions(a,[[b,e]],f);c.boardStruct[b][e]=a;var h=c.tryToTakePrisoners(a,b,e),i=Object.keys(h).length;if(c.lastPosition={x:parseInt(b),y:parseInt(e)},1===i&&c.lastPrisonersTaken.length){var j=c.lastPrisonersTaken[c.lastPrisonersTaken.length-1],k=j.forPlayer,l=j.x,m=j.y,n=[];for(var o in j.prisoners)n.push(parseInt(o.split(",")[0])),n.push(parseInt(o.split(",")[1]));var p=a,q=b,r=e,s=[];for(var o in h)s.push(parseInt(o.split(",")[0])),s.push(parseInt(o.split(",")[1]));var t=!1;if(p!==k&&s[0]===l&&s[1]===m&&n[0]===q&&n[1]===r&&(t=!0),t){for(var u=!1,o=c.playedPositions.length;;){if(0===o)break;if(o-=1,"move"===c.playedPositions[o].type&&!("undid"in c.playedPositions[o])){u=c.playedPositions[o].x===s[0]&&c.playedPositions[o].y===s[1];break}}u&&(i=0,alert("Immediate recapture is not allowed."))}}if(i){for(var o in h){var v=o.split(",")[0],w=o.split(",")[1];c.boardStruct[v][w]=-1}c.lastPrisonersTaken.push({forPlayer:a,x:b,y:e,prisoners:h}),0===c.getOppositePlayer(a)?c.blackPrisoners=parseInt(c.blackPrisoners)+i:c.whitePrisoners=parseInt(c.whitePrisoners)+i}return 0===Object.keys(g.liberties).length&&0===i?(c.boardStruct[b][e]=-1,!1):!0},c.adjacentPositionFinder=function(a,b){var d=0==a?!1:!0,e=b==c.boardSize-1?!1:!0,f=a==c.boardSize-1?!1:!0,g=0==b?!1:!0,h=[];if(f){{c.boardStruct[a+1][b]}h.push([a+1,b])}if(d){{c.boardStruct[a-1][b]}h.push([a-1,b])}if(e){{c.boardStruct[a][b+1]}h.push([a,b+1])}if(g){{c.boardStruct[a][b-1]}h.push([a,b-1])}return h},c.findDataForAdjacentPositions=function(a,b,e){if(d++,d>200)return{};var f={liberties:{},group:{}};for(var g in e){var h=e[g][0],i=e[g][1],j=c.boardStruct[h][i];if(-1===a&&-1!==j||-1!==a&&-1===j)f.liberties[h+","+i]=j;else{var k=!1;for(var l in b){var m=b[l][0],n=b[l][1];if(h===m&&i===n){k=!0;break}}if(!k&&j===a){var o=c.adjacentPositionFinder(h,i);o=_.filter(o,function(a){var c=a[0],d=a[1],e=!0;for(var f in b){var g=b[f][0],h=b[f][1];if(g==c&&h==d){e=!1;break}}return e}),b.push([h,i]);var p=c.findDataForAdjacentPositions(a,b,o);for(var l in p.liberties)f.liberties[l]=1}}}return f.group=b,f},c.tryToTakePrisoners=function(a,b,e){var f=c.adjacentPositionFinder(b,e),g=c.getOppositePlayer(a);f=_.filter(f,function(a){var b=a[0],d=a[1];return c.boardStruct[b][d]===g});var h={};for(var i in f){var j=f[i][0],k=f[i][1];d=0;var l=c.findDataForAdjacentPositions(g,[[b,e],[j,k]],c.adjacentPositionFinder(j,k));if(0===Object.keys(l.liberties).length){h[j+","+k]=g;for(var m in l.group){var n=l.group[m][0],o=l.group[m][1];c.boardStruct[n][o]===g&&(h[n+","+o]=g)}}}return h},c.moveStoneToXY=function(a,b,d){if(a!==c.currentPlayer)return!1;var e=c.getPositionValid(a,b,d);return e===!1?!1:(c.switchCurrentPlayer(),!0)},c.switchCurrentPlayer=function(){c.currentPlayer=c.getOppositePlayer(c.currentPlayer)},c.getColorClass=function(a){var b="";return 0===a?b="Black":1===a&&(b="White"),b},c.cachePlayedPosition=function(a){"pubnubUUID"in a||(a.pubnubUUID=c.pubnubUUID),"time"in a||(a.time=(new Date).getTime()),c.playedPositions.push(a)},c.rollBackHistoryUsingUndo=function(a){for(var b in a)delete a[b].undid;for(var b in a)if("type"in a[b]&&"undo"===a[b].type)for(var c=b;c-1>=0&&(c-=1,c>=0);)if("type"in a[c]&&"undo"!==a[c].type&&!("undid"in a[c])){a[c].undid=!0;break}return a},c.processPubNubPayload=function(a,b){if("type"in a)if(b||c.focused!==!1||sounds.play("chat"),"move"===a.type&&"forPlayer"in a&&"pubnubUUID"in a&&!c.movers[a.forPlayer]&&(c.movers[a.forPlayer]=a.pubnubUUID),"undid"in a)c.cachePlayedPosition(a);else if("move"===a.type&&"x"in a&&"y"in a&&"forPlayer"in a){var d=c.moveStoneToXY(parseInt(a.forPlayer),parseInt(a.x),parseInt(a.y));d&&c.cachePlayedPosition(a),!b&&c.turfIsVisible&&c.attemptToCalculateAndAssignScores()}else if("pass"===a.type&&"forPlayer"in a){if(parseInt(c.currentPlayer)===parseInt(a.forPlayer))if(c.movers[a.forPlayer]&&c.movers[a.forPlayer]!==a.pubnubUUID);else{var e=c.playedPositions[c.playedPositions.length-1];"pass"===e.type&&(c.turfIsVisible=!0,c.attemptToCalculateAndAssignScores()),c.cachePlayedPosition(a),c.switchCurrentPlayer()}}else"undo"===a.type&&(c.cachePlayedPosition(a),b===!1&&c.undo())},c.undo=function(){var a=c.rollBackHistoryUsingUndo(c.playedPositions);c.init();for(var b in a)c.processPubNubPayload(a[b],!0);c.turfIsVisible&&c.attemptToCalculateAndAssignScores()},c.attemptToCalculateAndAssignScores=function(){var a=[],b={},e=0;for(var f in c.boardStruct)for(var g in c.boardStruct[f])if(f=parseInt(f),g=parseInt(g),-1===c.boardStruct[f][g]){e++;var h=c.adjacentPositionFinder(f,g);d=0;var i=c.findDataForAdjacentPositions(-1,[[f,g]],h);a.push(i)}var j=0,k=0;for(var l in a){var m=[];for(var n in a[l].liberties){var o=parseInt(n.split(",")[0]),p=parseInt(n.split(",")[1]);m.push(c.boardStruct[o][p])}var q=m.length===_.filter(m,function(a){return a===m[0]}).length;if(q&&(1===m[0]||0===m[0])){0===m[0]?j++:1===m[0]&&k++;for(var n in a[l].group){var o=parseInt(a[l].group[n][0]),p=parseInt(a[l].group[n][1]);b[o+","+p]={forPlayer:m[0],x:o,y:p}}}}c.blackTurf={},c.whiteTurf={};for(var n in b){var o=parseInt(b[n].x),p=parseInt(b[n].y);0===b[n].forPlayer?c.blackTurf[o+","+p]=1:1===b[n].forPlayer&&(c.whiteTurf[o+","+p]=1)}return c.dataChangedCallback(),[j,k]},c.toggleTurfCount=function(){c.turfIsVisible=!c.turfIsVisible,c.turfIsVisible&&c.attemptToCalculateAndAssignScores()},c.init=function(){c.boardStruct=c.createEmptyBoardStruct(),c.blackPrisoners=0,c.whitePrisoners=0,c.currentPlayer=0,c.lastPosition={},c.playedPositions=[],c.lastPrisonersTaken=[],c.whiteTurf=0,c.blackTurf=0,c.movers={},c.initted||(window.onblur=c.handleOnBlur,window.onfocus=c.handleOnFocus),c.initted=!0},c.init(),c};window.CREATE_GO=a}();